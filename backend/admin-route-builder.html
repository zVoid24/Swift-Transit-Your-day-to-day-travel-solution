<!DOCTYPE html>
<html>

<head>
  <title>Swift Transit - Route Builder</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <!-- Optional: Leaflet Control Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    #controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      max-width: 300px;
    }

    input,
    button {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      box-sizing: border-box;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    #output {
      width: 100%;
      height: 150px;
      font-family: monospace;
      font-size: 12px;
      display: none;
    }

    .instruction {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="controls">
    <h3>Route Builder</h3>
    <div class="instruction">
      ▶ Click on map: 1st = start, 2nd = end, more = intermediate stops.<br />
      ▶ Drag blue line to adjust route.<br />
      ▶ Click markers to rename or delete stops.<br />
      ▶ Export = GeoJSON.<br /><br />
      Optional: paste Mapbox token to use Mapbox routing.
    </div>

    <input type="text" id="mapboxToken" placeholder="Mapbox Access Token (pk....)" value="" />
    <input type="text" id="routeName" placeholder="Route Name" value="New Route" />

    <button onclick="exportRoute()">Export JSON</button>
    <button onclick="loadRouteFromLocalStorage()">Restore Previous Route</button>

    <textarea id="output"></textarea>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Routing Machine JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Optional: Leaflet Control Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <script>
    // Initialize Map (Dhaka default)
    var map = L.map("map").setView([23.8103, 90.4125], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
    }).addTo(map);

    var control = null;
    var clickWaypoints = [];

    // -----------------------------
    // AUTO SAVE SYSTEM (LOCALSTORAGE)
    // -----------------------------
    function saveRouteToLocalStorage() {
      const data = {
        waypoints: clickWaypoints,
        routeName: document.getElementById("routeName").value
      };
      localStorage.setItem("swiftTransitRoute", JSON.stringify(data));
    }

    function loadRouteFromLocalStorage() {
      const saved = localStorage.getItem("swiftTransitRoute");
      if (!saved) {
        alert("No saved route found.");
        return false;
      }

      try {
        const data = JSON.parse(saved);
        if (!data.waypoints || data.waypoints.length === 0) {
          alert("Saved route is empty.");
          return false;
        }

        clickWaypoints = data.waypoints.map(latlng => L.latLng(latlng.lat, latlng.lng));

        document.getElementById("routeName").value = data.routeName || "New Route";
        control.setWaypoints(clickWaypoints);

        alert("Route restored successfully.");
        return true;
      } catch (e) {
        console.error("Failed to restore:", e);
        alert("Error restoring saved route.");
        return false;
      }
    }

    // -----------------------------
    // CREATE MARKERS (RENAME + DELETE)
    // -----------------------------
    function createMarker(i, wp, nWps) {
      var marker = L.marker(wp.latLng, { draggable: true });

      // Add 140m radius circle
      var circle = L.circle(wp.latLng, {
        radius: 140,
        color: 'blue',
        fillColor: '#30f',
        fillOpacity: 0.2
      }).addTo(map);

      // Sync circle with marker drag
      marker.on('drag', function(e) {
        circle.setLatLng(e.target.getLatLng());
      });

      // Remove circle when marker is removed
      marker.on('remove', function() {
        if (map.hasLayer(circle)) {
          map.removeLayer(circle);
        }
      });

      if (!wp.name) {
        wp.name = "Stop " + (i + 1);
      }

      marker.bindPopup(function () {
        var container = L.DomUtil.create("div");

        var input = L.DomUtil.create("input", "", container);
        input.type = "text";
        input.value = wp.name;

        var saveBtn = L.DomUtil.create("button", "", container);
        saveBtn.innerHTML = "Save Name";
        saveBtn.onclick = function () {
          wp.name = input.value;
          saveRouteToLocalStorage();
          marker.closePopup();
        };

        var deleteBtn = L.DomUtil.create("button", "", container);
        deleteBtn.innerHTML = "Delete Stop";
        deleteBtn.style.marginTop = "6px";
        deleteBtn.style.background = "#dc3545";
        deleteBtn.style.color = "white";
        deleteBtn.onclick = function () {
          map.removeLayer(marker);
          clickWaypoints.splice(i, 1);
          control.setWaypoints(clickWaypoints);
          saveRouteToLocalStorage();
          marker.closePopup();
        };

        return container;
      });

      return marker;
    }

    // -----------------------------
    // ROUTING ENGINE INIT
    // -----------------------------
    function initRouting(token) {
      if (control) map.removeControl(control);

      clickWaypoints = [];

      var router;
      if (token && token.trim() !== "") {
        router = L.Routing.mapbox(token.trim());
      } else {
        router = L.Routing.osrmv1({
          serviceUrl: "https://router.project-osrm.org/route/v1",
        });
      }

      control = L.Routing.control({
        waypoints: [],
        router: router,
        routeWhileDragging: true,
        show: false,
        geocoder: L.Control.Geocoder ? L.Control.Geocoder.nominatim() : null,
        createMarker: createMarker,
      }).addTo(map);
    }

    var tokenInput = document.getElementById("mapboxToken");
    var lastTokenValue = tokenInput.value;

    // -----------------------------------
    // SAFE TOKEN CHANGE (CONFIRM FIRST)
    // -----------------------------------
    tokenInput.addEventListener("input", function (e) {
      if (e.target.value !== lastTokenValue) {
        const ok = confirm(
          "Changing Mapbox token will reset routing.\nDo you want to continue?"
        );
        if (!ok) {
          e.target.value = lastTokenValue;
          return;
        }

        lastTokenValue = e.target.value;
        initRouting(lastTokenValue);

        setTimeout(() => {
          loadRouteFromLocalStorage();
        }, 500);
      }
    });

    // Initial routing engine
    initRouting(tokenInput.value);

    // -----------------------------------
    // ADD WAYPOINTS BY CLICKING
    // -----------------------------------
    map.on("click", function (e) {
      clickWaypoints.push(e.latlng);
      control.setWaypoints(clickWaypoints);
      saveRouteToLocalStorage();
    });

    // -----------------------------------
    // EXPORT ROUTE AS GEOJSON
    // -----------------------------------
    function createGeoJSONCircle(center, radiusInMeters, points) {
      if (!points) points = 64;

      var lng = center[0];
      var lat = center[1];

      var coords = [];
      var distanceX = radiusInMeters / (111320.0 * Math.cos(lat * Math.PI / 180.0));
      var distanceY = radiusInMeters / 110574.0;

      var theta, x, y;
      for (var i = 0; i < points; i++) {
        theta = (i / points) * (2 * Math.PI);
        x = distanceX * Math.cos(theta);
        y = distanceY * Math.sin(theta);

        coords.push([lng + x, lat + y]);
      }
      coords.push(coords[0]); // Close the ring

      return [coords];
    }

    function exportRoute() {
      if (!control || !control._routes || control._routes.length === 0) {
        alert("No route found.");
        return;
      }

      var route = control._routes[0];
      var coords = route.coordinates.map(c => [c.lng, c.lat]);
      var indices = route.waypointIndices || [];
      var waypoints = control.getWaypoints();

      var routeName = document.getElementById("routeName").value;

      var geojson = {
        name: routeName,
        type: "FeatureCollection",
        features: []
      };

      geojson.features.push({
        type: "Feature",
        geometry: {
          type: "LineString",
          coordinates: coords,
        },
        properties: { type: "route" }
      });

      waypoints.forEach(function (wp, index) {
        if (!wp || !wp.latLng) return;

        var coordIndex = indices[index];
        var snapped = coords[coordIndex] || [wp.latLng.lng, wp.latLng.lat];
        var stopName = wp.name || "Stop " + (index + 1);

        // Add Point
        geojson.features.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: snapped },
          properties: { Name: stopName, order: index + 1 }
        });

        // Add Circle Polygon
        var polygonCoords = createGeoJSONCircle(snapped, 140);
        geojson.features.push({
          type: "Feature",
          geometry: {
            type: "Polygon",
            coordinates: polygonCoords
          },
          properties: {
            Name: stopName,
            type: "stop_area"
          }
        });
      });

      var output = document.getElementById("output");
      output.style.display = "block";
      output.value = JSON.stringify(geojson, null, 2);
      output.select();

      navigator.clipboard.writeText(output.value);
      alert("JSON copied to clipboard.");
    }
  </script>

</body>

</html>
